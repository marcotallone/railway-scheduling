<!doctype html>
<html lang="en">


	<!-- Head ---------------------------------------------------------------->
	<head>

		<!-- Metadata -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,
					maximum-scale=1.0, user-scalable=no">
		<title>MPC Tracking</title>
		<meta name="description" content="Non-linear Reference Tracking via
					Model Predictive Control and Extended Kalman Filter">
		<meta name="author" content="Marco Tallone">

		<!-- Style Settings -->
		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/personal.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/nnfx-light.css">

		<!-- Personal CSS Styling -->
		<link rel="stylesheet" href="style.css" />

	</head>


	<!-- Body ---------------------------------------------------------------->
	<body>

		<!-- Start of slides -->
		<div class="reveal">
		<div class="slides">

		<!-- Slide 1: Title -------------------------------------------------->
		<section 
			 data-transition="fade"
			 data-background-video="./images/topographic-background-cmp.mp4"
			 data-background-video-loop 
			 data-background-video-muted 
			 data-background-opacity="1"
			 data-state="hide-menubar hide-menu"
		>

			<!-- Main Title -->
			<div class="main-title-container" data-id="title-container">
				<h1>Non-linear Reference Tracking<br>
					via Model Predictive Control (MPC)<br>
					and Extended Kalman Filter (EKF)</h1>
			</div>

			<!-- Subtitle -->
			<p style="margin-bottom: 0px; font-size: 0.8em;">
				Exam Project<br> 
				Modelling and Control of Cyber-Physical Systems II<br>
				SDIC Master Degree, University of Trieste (UniTS)
			</p>

			<!-- Author and Date -->
			<p style="margin-bottom: 0px; font-size: 0.8em;">
				Marco Tallone<br>
				February 2025
			</p>

			<!-- Logos -->
			<div class="main-title-image">
				<div class="main-title-image-item">
					<img src="./images/sdic-logo.png" height="150px" />
				</div>
				<div class="main-title-image-item">
					<img src="./images/units-blue.png" height="150px" />
				</div>
			</div>

		</section>

		<!-- Slide 2: Objectives and ToC ------------------------------------->
		<section 
			 data-background-video="./images/topographic-background-cmp.mp4"
			 data-background-video-loop 
			 data-background-video-muted 
			 data-background-opacity="1"
			 data-state="hide-menubar hide-menu"
		>

			<h1 class="slide-title">Introduction</h1>


			<div class="slide-body">

				<br>

				<h2>Objectives</h2>
				<ul>
					<li>Implement a Model Predictive Controller (MPC) for
						non-linear systems (in <code style="color:
													 var(--primary); font-weight: bold;">MATLAB</code>)</li>
					<li>Implement an Extended Kalman Filter (EKF) for 
						state estimation (in <code style="color:
													 var(--primary); font-weight: bold;">MATLAB</code>)</li>
					<li>Reproduce results by 
						<span style="font-style: italic;">Kunz, Huck and
							Summers</span> [<a href="#ref1">1</a>]
						on a miniature helicopter
					</li>
					<li>Test and validate the implementation on different models
					and trajectories</li>
				</ul>

				<br>
				<br>

				<div class="cbox" 
					style="background-color: var(--primary);
						   text-align: center;
						   color: white;
						   padding: 30px;
						   font-size: 1em;
					">
				<h2 style="color: white;">Table of Contents</h2>
				<ol class="spaced-list">
					<li>Non-Linear Models</li>
					<li>Trajectory Generation Mehtods</li>
					<li>MPC Problem Formulation</li>
					<li>Extended Kalman Filter</li>
					<li>Validation and Results</li>
				</ol>
				</div>

			</div>
			
		</section>

		<!-- Section: Models ------------------------------------------------->
		<section data-name="Non-Linear Models">

			<section data-background-color="var(--primary)">
				<div class="section-title-container">
					<h1 style="font-size: 2em;">Non-Linear Models</h1>
				</div>
			</section>

		<!-- Slide 3: Non-linear Models -------------------------------------->
		<section data-transition="slide">
			<h1 class="slide-title">Unicycle Model</h1>

			<div class="slide-body">

				<div class="multi-column">

					<div class="column" 
						 style="width: 30%; 
								border-right: 1px solid var(--primary); 
								padding-right: 10px;
								margin-right: 10px;
						">
						<h2 style="text-align: center;">Non-linear Dynamics</h2>
						<p>
						\[
						\begin{cases}
						\dot{x} = \frac{r}{2} (\omega_1 + \omega_2) \cos(\theta)\\
						\dot{y} = \frac{r}{2} (\omega_1 + \omega_2) \sin(\theta)\\
						\dot{\theta} = \frac{r}{L} (\omega_1 - \omega_2)
						\end{cases}
						\]
						</p>
						<p>
						\[
						\begin{aligned}
							\text{State:} \quad & \mathbf{x}(t) =
							\begin{bmatrix} x(t) & y(t) & \theta(t)
							\end{bmatrix}^T \\
							\text{Input:} \quad & \mathbf{u}(t) =
							\begin{bmatrix} \omega_1(t) & \omega_2(t)
							\end{bmatrix}^T
						\end{aligned}
						\]
						</p>
						<div style="display: flex; justify-content: space-between;">
							<img src="./images/unicycle-model.png" style="width:
							49%;">
							<img src="./images/roomba.gif" style="width: 49%;">
						</div>

					</div>

					<div class="column" style="width: 69%;">
						<h2 style="text-align: center;"><code style="color:
								   var(--primary);">MATLAB</code> Class
							Implementation</h2>
<pre style="width: 100%; height: 90%;"><code><script type="text/template">classdef Unicycle < DynamicalSystem
    properties
        % Model parameters
        n = 3;
        m = 2;
        p = 2;
        Ts;
        r;
        L;
				...
    end
    
    methods
        % Constructor
        function obj = Unicycle(r, L, Ts, x_constraints, u_constraints, 
														    P0, Q_tilde, R_tilde)
            obj.r = r;
            obj.L = L;
            obj.Ts = Ts;
						...
        end

        % State transition function
        function dxdt = dynamics(obj, t, x, u)
            theta = x(3);                               
            omega1 = u(1);                              
            omega2 = u(2);                             
            v = obj.r / 2 * (omega1 + omega2);          
            omega = obj.r / obj.L * (omega2 - omega1);  
            dx_posdt = v * cos(theta);                  
            dy_posdt = v * sin(theta);                  
            dthetadt = omega;                           
            dxdt = [dx_posdt; dy_posdt; dthetadt];
        end

        % Simulation function
        function x_final = simulate(obj, x0, u, T)
            x0(3) = wrapTo2Pi(x0(3));
            [t, x] = ode45(@(t, x) obj.dynamics(t, x, u), [0, T], x0);
            x_final = (x(end, :))';
            x_final(3) = wrapTo2Pi(x_final(3));
        end

        % Output transformation function
        function y = output(obj, x, u)
            y = [x(1); x(2)];
        end
        
        % Linearization function
        function [A_lin, B_lin] = linearize(obj, x_bar, u_bar)
						...
        end

				...
				...
				...

        % Extended Kalman Filter (EKF) state estimation
        function x_hat = EKF_estimate(obj, x_hat, u, y)
						...
        end


        % Trajectory generation function
        function [x_ref, u_ref, Tend] = generate_trajectory(...)
						...
        end
    end
end
</script></code></pre>
					</div>


			</div>

		</section>
		<section data-transition="slide">
			<h1 class="slide-title">Helicopter Model</h1>

			<div class="slide-body">

				<div class="multi-column">

					<div class="column" 
						 style="width: 33%; 
								border-right: 1px solid var(--primary); 
								padding-right: 10px;
								margin-right: 10px;
						">
						<h2 style="text-align: center;">Non-linear Dynamics</h2>
						<p>
						\[
						\begin{cases}
						\dot{x}_I = cos(\psi) \dot{x}_B - sin(\psi) \dot{y}_B\\
\dot{y}_I = sin(\psi) \dot{x}_B + cos(\psi) \dot{y}_B\\
						\dot{z}_I = \dot{z}_B\\
						\ddot{x}_B = b_x u_x + k_x \dot{x}_B + \dot{\psi} \dot{y}_B\\
						\ddot{y}_B = b_y u_y + k_y \dot{y}_B - \dot{\psi} \dot{x}_B\\
						\dot{z}_B = b_z u_z - g\\
						\dot{\psi} = \dot{\psi}\\
						\ddot{\psi} = b_{\psi} u_{\psi} + k_{\psi} \dot{\psi}
						\end{cases}
						\]
						</p>
						<p>
						\[
						8 \text{ states}, \quad\quad 4 \text{ inputs}
						\]
						</p>
						<div style="display: flex; justify-content: space-between;">
							<img src="./images/helicopter-model.png" style="width:
							49%;">
							<img src="./images/helicopter.gif" style="width: 49%;">
						</div>

					</div>

					<div class="column" style="width: 67%;">
						<h2 style="text-align: center;"><code style="color:
								   var(--primary);">MATLAB</code> Class
							Implementation</h2>
<pre style="width: 100%; height: 85%;"><code><script type="text/template">classdef Helicopter < DynamicalSystem
    properties
        % Model parameters
        n = 8;
        m = 4;
        p = 4;
        Ts;
        bx;
        by;
        bz;
        bpsi;
        kx;
        ky;
        kpsi;
        ki;
        g = 9.81;
		...
    end

   methods
        % Constructor
        function obj = Helicopter(parameters, Ts, x_constraints, u_constraints,
                                  P0, Q_tilde, R_tilde)
						...
        end

        % State transition function
        function dxdt = dynamics(obj, t, x, u)
            dxidt = cos(x(7)) * x(4) - sin(x(7)) * x(5);
            dyidt = sin(x(7)) * x(4) + cos(x(7)) * x(5);
            dzidt = x(6);
            dvxbdt = obj.bx * u(1) + obj.kx * x(4) + x(8) * x(5);
            dvybdt = obj.by * u(2) + obj.ky * x(5) - x(8) * x(4);
            dvzbd = obj.bz * u(3) - obj.g;
            dpsidt = x(8);
            dvpsidt = obj.bpsi * u(4) + obj.kpsi * x(8);

            dxdt = [dxidt; dyidt; dzidt; dvxbdt; dvybdt; dvzbd; dpsidt; dvpsidt];
        end

        % Simulation function
        function x_final = simulate(obj, x0, u, T)
            x0(7) = wrapTo2Pi(x0(7));

            [t, x] = ode45(@(t, x) obj.dynamics(t, x, u), [0, T], x0);
            x_final = (x(end, :))';
            x_final(7) = wrapTo2Pi(x_final(7));
        end

        % Output transformation function
        function y = output(obj, x, u)
            y = [x(1); x(2); x(3); x(7)];
        end
        
        % Linearization function
        function [A_lin, B_lin] = linearize(obj, x_bar, u_bar)
						...
        end

        % Fix reference angles function
        function x_ref_fixed = fix_angles(obj, x, x_ref)
						...
        end

        % Extended Kalman Filter (EKF) state estimation
        function x_hat = EKF_estimate(obj, x_hat, u, y)
						...
        end

        % Trajectory generation function
        function [x_ref, u_ref, Tend] = generate_trajectory(...)
						...
        end
    end
end
</script></code></pre>
					</div>


			</div>

		</section>


		</section>

		<!-- Section: Trajectory Generation ---------------------------------->
		<section data-name="Trajectory Generation">

			<section data-background-color="var(--primary)">
				<div class="section-title-container">
					<h1 style="font-size: 2em;">Trajectory Generation</h1>
				</div>
			</section>

		<!-- Slide 4: Flat Outputs ------------------------------------------->
		<section data-transition="slide">
			<br>
			<h1 class="slide-title">Flat Outputs</h1>

			<br>

			<div class="slide-body">

				<div class="cbox" style="margin-bottom: 10px;">
					<h2 style="margin-bottom: 0px;">Differential Flatness</h2>
					<p>
					A <i>non-linear</i> dynamical system $\mathbf{\dot{x}} =
					\mathbf{f}(\mathbf{x}, \mathbf{u})$ is said to be <i>differentially
						flat</i> if there exists a function $\Gamma(\cdot)$ such
					that
					\[
					\mathbf{z} = \Gamma(\mathbf{x}, \mathbf{u},
					\dot{\mathbf{u}}, \ldots, \mathbf{u}^{(p)})
					\]
					where $\mathbf{z}$ are <i>flat outputs</i>.
				</div>

				<div class="multi-column">

					<!-- Unicycle Flat Outputs -->
					<div class="column" 
						 style="width: 30%; 
								border-right: 1px solid var(--primary); 
								padding-right: 10px;
								margin-right: 10px;
					">
						<h2 style="text-align: center;">Unicycle Model</h2>
						<p style="font-size: 0.9em;">
						\[z_1 = x \quad\text{ and }\quad z_2 = y \]
						\[
						\begin{aligned}
						\theta &= \arctan\left(\frac{\dot{z_2}}{\dot{z_1}}\right)\\
						\omega_1 &= \frac{2 \sqrt{\dot{z_1}^2 + \dot{z_2}^2} + L
						\dot{\theta}}{2 r}\\
						\omega_2 &= \frac{2 \sqrt{\dot{z_1}^2 + \dot{z_2}^2} - L \dot{\theta}}{2 r}
						\end{aligned}
						\]
						</p>
					</div>

					<!-- Helicopter Flat Outputs -->
					<div class="column">
						<h2 style="text-align: center;">Helicopter Model</h2>
						<p style="font-size: 0.9em;">
						\[
						z_1 = x_I, \quad z_2 = y_I, \quad z_3 = z_I, \quad z_4 = \psi
						\]
						\[
						\begin{aligned}
						\dot{x}_B &= \cos(z_4) \dot{z}_1 + \sin(z_4) \dot{z}_2, \quad\quad \dot{z}_B = \dot{z}_3\\
						\dot{y}_B &= -\sin(z_4) \dot{z}_1 + \cos(z_4) \dot{z}_2, \quad\quad \dot{\psi} = \dot{z}_4\\
						u_x &= \frac{1}{b_x} \left( cos(z_4) \left[ \ddot{z}_1 - k_x \dot{z}_1
						\right] + sin(z_4) \left[ \ddot{z}_2 - k_x \dot{z}_2 \right] \right)\\
						u_y &= \frac{1}{b_y} \left( cos(z_4) \left[ \ddot{z}_2 - k_y \dot{z}_2 \right] + sin(z_4) \left[ -\ddot{z}_1 + k_y \dot{z}_1 \right] \right)\\
						u_z &= \frac{1}{b_z} \left( \ddot{z}_3 + g \right), \quad u_{\psi} = \frac{1}{b_{\psi}} \left( \ddot{z}_4 - k_{\psi} \dot{z}_4
						\right)
						\end{aligned}
						\]
						</p>
					</div>

				</div>

			</div>
		</section>

		<!-- Slide 5: Analytical Trajectory Generation ----------------------->
		<section data-transition="slide" data-auto-animate>
			<h1 class="slide-title">Analytical Trajectory Generation</h1>

			<br>

			<div class="slide-body">

				<div class="multi-column">

					<!-- Circle -->
					<div class="column" style="width: 25%;">
						<h2 style="text-align: center;">Circle</h2>
						<p style="font-size: 1em;" data-id="circle-text">
						\[
						\begin{cases}
						z_1(t) = r_0 \cos(t)\\
						z_2(t) = r_0 \sin(t)\\
						z_3(t) = 0\\
						z_4(t) = \text{atan2}\left(\dot{z}_2(t), \dot{z}_1(t)\right)
						\end{cases}
						\]
						</p>
						<div style="display: flex; justify-content: center;"
							 data-id="circle-image">
							<img src="./images/circular_reference-b.gif"
								  style="heigth: 300px; width: 300px; border: 1px
										 solid var(--primary);">
						</div>
					</div>

					<!-- Lemniscate -->
					<div class="column" style="width: 74%;">
						<h2 style="text-align: center;">Lemniscate</h2>
						<p style="font-size: 1em; margin-bottom: -10px;"
						   data-id="lemniscate-text">
						\[
						\begin{cases}
						z_1(t) = \frac{a \sqrt{2} \cos(t)}{\sin(t)^2 + 1}\\
						z_2(t) = \frac{a \sqrt{2} \cos(t) \sin(t)}{\sin(t)^2 + 1}\\
						z_3(t) = 0\\
						z_4(t) = \text{atan2}\left(\dot{z}_2(t), \dot{z}_1(t)\right)
						\end{cases}
						\]
						</p>
						<div style="display: flex; justify-content: center;" 
							 data-id="lemniscate-image">
							<img src="./images/lemniscate_reference-b.gif" style="width:
								  700px; height: 300px; border: 1px solid
								  var(--primary);">
						</div>
					</div>

				</div>

				<p>
				Sample trajectories at time steps
				$\{t_k\}_{k=1}^{N_{guide}}$	$\rightarrow$ obtain $N_{guide}$ reference
				points $\{(\mathbf{x}_{\text{ref}, k}, \mathbf{u}_{\text{ref}, k})\}_{k=1}^{N_{guide}}$
				</p>
				<p>
				Total time to complete the
				trajectory set to:
				$\quad T_{end} = N_{guide} \cdot T_s$
				</p>
				<div class="cbox" style="font-size: 1em;"
								  data-id="inputs-warning">
				<span style="color: black;">⚠</span>
				Discrete reference inputs $\mathbf{u}_{\text{ref}, k}$ $\rightarrow$ from averages of
				continuous-time inputs $\mathbf{u}_{\text{ref}}(t)$:<br>
				\[ \mathbf{u}_{\text{ref}, k} = \frac{1}{N_{samples}}
				\sum_{i=1}^{N_{samples}} \mathbf{u}_{\text{ref}}\left(t_k +
				\frac{i \cdot T_s}{N_{samples}} \right) \]
				</div>

			</div>

		</section>
		<section data-auto-animate>
			<h1 class="slide-title">Analytical Trajectory Generation</h1>

			<br>

			<div class="slide-body">

				<div class="multi-column">

					<!-- Circle -->
					<div class="column" style="width: 25%;">
						<h2 style="text-align: center;">Circle</h2>
						<p style="font-size: 1em;" data-id="circle-text">
						\[
						\begin{cases}
						z_1(t) = r_0 \cos(t)\\
						z_2(t) = r_0 \sin(t)\\
						z_3(t) = 0\\
						z_4(t) = \text{atan2}\left(\dot{z}_2(t), \dot{z}_1(t)\right)
						\end{cases}
						\]
						</p>
					</div>

					<!-- Lemniscate -->
					<div class="column" style="width: 74%;">
						<h2 style="text-align: center;">Lemniscate</h2>
						<p style="font-size: 1em; margin-bottom: -10px;"
						   data-id="lemniscate-text">
						\[
						\begin{cases}
						z_1(t) = \frac{a \sqrt{2} \cos(t)}{\sin(t)^2 + 1}\\
						z_2(t) = \frac{a \sqrt{2} \cos(t) \sin(t)}{\sin(t)^2 + 1}\\
						z_3(t) = 0\\
						z_4(t) = \text{atan2}\left(\dot{z}_2(t), \dot{z}_1(t)\right)
						\end{cases}
						\]
						</p>
						<!-- <div style="display: flex; justify-content: center;"> -->
						<!-- 	<img src="./images/lemniscate_reference.gif" style="width: -->
						<!-- 		  700px; height: 300px; border: 1px solid -->
						<!-- 		  var(--primary);"> -->
						<!-- </div> -->
					</div>

				</div>

				<p>
				Sample trajectories at time steps
				$\{t_k\}_{k=1}^{N_{guide}}$	$\rightarrow$ obtain $N_{guide}$ reference
				points $\{(\mathbf{x}_{\text{ref}, k}, \mathbf{u}_{\text{ref}, k})\}_{k=1}^{N_{guide}}$
				</p>
				<p>
				Total time to complete the
				trajectory set to:
				$\quad T_{end} = N_{guide} \cdot T_s$
				</p>
				<div class="cbox" style="font-size: 1em;"
								  data-id="inputs-warning">
				<span style="color: black;">⚠</span>
				Discrete reference inputs $\mathbf{u}_{\text{ref}, k}$ $\rightarrow$ from averages of
				continuous-time inputs $\mathbf{u}_{\text{ref}}(t)$:<br>
				\[ \mathbf{u}_{\text{ref}, k} = \frac{1}{N_{samples}}
				\sum_{i=1}^{N_{samples}} \mathbf{u}_{\text{ref}}\left(t_k +
				\frac{i \cdot T_s}{N_{samples}} \right) \]
				</div>

			</div>

		</section>
		<section data-auto-animate>
			<h1 class="slide-title">Analytical Trajectory Generation</h1>

			<br>

			<div class="slide-body">

				<div class="cbox" style="font-size: 0.6em;"
								  data-id="inputs-warning">
				<span style="color: black;">⚠</span>
				Discrete reference inputs $\mathbf{u}_{\text{ref}, k}$ $\rightarrow$ from averages of
				continuous-time inputs $\mathbf{u}_{\text{ref}}(t)$:<br>
				\[ \mathbf{u}_{\text{ref}, k} = \frac{1}{N_{samples}}
				\sum_{i=1}^{N_{samples}} \mathbf{u}_{\text{ref}}\left(t_k +
				\frac{i \cdot T_s}{N_{samples}} \right) \]
				</div>

				<div style="display: flex; justify-content: center;">
					<img src="./images/unicycle_samples.gif" style="width: 75%;
							  border: 1px solid var(--primary);">
				</div>

			</div>

		</section>
		<section data-auto-animate>
			<h1 class="slide-title">Analytical Trajectory Generation</h1>

			<br>

			<div class="slide-body">
				<p>
				Simulations from first reference (<i>Helicopter</i>)
				</p>
				<div class="section-title-container" style="height: 85%;"
													 data-id="simulation">
					<img src="./images/helicopter_simulation.gif"
					style="height: 400px; width: 700px; border: 1px solid black;">
					<img src="./images/helicopter_simulation_zoom.gif"
					style="height: 400px; width: 400px; border: 1px solid black;">
				</div>
			</div>

		</section>
		<section data-auto-animate>
			<h1 class="slide-title">Analytical Trajectory Generation</h1>

			<br>

			<div class="slide-body">
				<p>
				Simulations from first reference (<i>Helicopter</i>)
				</p>
				<div class="section-title-container" style="height: 85%;"
													 data-id="simulation">
					<img src="./images/helicopter_simulation_ref.gif"
					style="height: 400px; width: 700px; border: 1px solid black;">
					<img src="./images/helicopter_simulation_ref_zoom.gif"
					style="height: 400px; width: 400px; border: 1px solid black;">
				</div>
			</div>

		</section>

		<!-- Slide 6: Murray Method ------------------------------------------>
		<section data-transition="slide">
			<h1 class="slide-title">Murray Method</h1>

			<br>

			<div class="slide-body">

				<div class="multi-column">
					<div class="column" style="width: 45%;">
						<div class="cbox" style="text-align: center; padding:
									5px;">
							Non-linear dynamics $\quad \mathbf{\dot{x}}(t) =
							\mathbf{f}(\mathbf{x}(t), \mathbf{u}(t))$
						</div>
					</div>
					<div class="column" style="width: 45%;">
						<div class="cbox" style="text-align: center; padding:
									5px;">
							Flat outputs $\quad \mathbf{z}(t)$
						</div>
					</div>
				</div>

				<p style="text-align: left;">
					Given the known flat outputs and their derivatives up to
					order $q$ between $T_0=0$ and $T_f=T$:
					\[ \bar{\mathbf{z}} = \begin{bmatrix} \mathbf{z}(0) & \dot{\mathbf{z}}(0) & \ldots & \mathbf{z}^{(q)}(0) & \mathbf{z}(T) & \dot{\mathbf{z}}(T) & \ldots & \mathbf{z}^{(q)}(T) \end{bmatrix}^T \]
				</p>

				<p style="text-align: left;">
					Parametrize $\mathbf{z}(t)$ as a linear combination of
					$N_{\text{basis}}$ basis functions $\mathbf{b}_i(t)$:
					$\quad \mathbf{z}(t) = \sum_{i=1}^{N_{\text{basis}}}
					\alpha_i \mathbf{b}_i(t) $
					<br>
					As explained in [<a href="#ref2">2</a>], find coefficients $\alpha_i$ solving the linear system:
				</p>

				<p style="text-align: left; font-size: 0.9em;">
					\[
					\begin{bmatrix}
					\mathbf{b}_1(0) & \mathbf{b}_2(0) & \ldots & \mathbf{b}_{N_{\text{basis}}}(0) \\
					\dot{\mathbf{b}}_1(0) & \dot{\mathbf{b}}_2(0) & \ldots & \dot{\mathbf{b}}_{N_{\text{basis}}}(0) \\
					\vdots & \vdots & \ddots & \vdots \\
					\mathbf{b}_1^{(q)}(0) & \mathbf{b}_2^{(q)}(0) & \ldots & \mathbf{b}_{N_{\text{basis}}}^{(q)}(0) \\
					\mathbf{b}_1(T) & \mathbf{b}_2(T) & \ldots & \mathbf{b}_{N_{\text{basis}}}(T) \\
					\dot{\mathbf{b}}_1(T) & \dot{\mathbf{b}}_2(T) & \ldots & \dot{\mathbf{b}}_{N_{\text{basis}}}(T) \\
					\vdots & \vdots & \ddots & \vdots \\
					\mathbf{b}_1^{(q)}(T) & \mathbf{b}_2^{(q)}(T) & \ldots & \mathbf{b}_{N_{\text{basis}}}^{(q)}(T)
					\end{bmatrix}
					\begin{bmatrix}
					\alpha_1 \\ \alpha_2 \\ \vdots \\ \alpha_{N_{\text{basis}}}
					\end{bmatrix}
					=
					\begin{bmatrix}
					\mathbf{z}(0) \\ \dot{\mathbf{z}}(0) \\ \vdots \\ \mathbf{z}^{(q)}(0) \\
					\mathbf{z}(T) \\ \dot{\mathbf{z}}(T) \\ \vdots \\ \mathbf{z}^{(q)}(T)
					\end{bmatrix}
					\]
				</p>

			</div>

		</section>

		</section>


		<!-- Section: MPC Problem Formulation -------------------------------->
		<section data-name="MPC Formulation">

			<section data-background-color="var(--primary)">
				<div class="section-title-container">
					<h1 style="font-size: 2em;">MPC Problem Formulation</h1>
				</div>
			</section>

		<!-- Slide 7: LTV Model ---------------------------------------------->
		<section data-transition="fade">
			<h1 class="slide-title">LTV Model</h1>

			<div class="slide-body">

				<p>
				Given set of nominal state and inputs at regular times
				$T_s$:
				\[
				\begin{aligned}
				\bar{\mathbf{x}}_k &= \bar{\mathbf{x}}(k T_s), \quad k = k_0, \ldots, k_0 + N + 1\\
				\bar{\mathbf{u}}_k &= \bar{\mathbf{u}}(k T_s), \quad k = k_0, \ldots, k_0 + N
				\end{aligned}
				\]
				</p>
				<p>
				<b>Linearize</b> the non-linear model around the nominal trajectory:
				\[
				\delta \mathbf{x}(t) = \mathbf{A}_k \delta \mathbf{x}(t) + \mathbf{B}_k \delta
				\mathbf{u}(t)
				\]
				\[
				\mathbf{A}_k = \left. \frac{\partial \mathbf{f}}{\partial \mathbf{x}}
				\right|_{\bar{\mathbf{x}}_k, \bar{\mathbf{u}}_k}, \quad
				\mathbf{B}_k = \left. \frac{\partial \mathbf{f}}{\partial \mathbf{u}}
				\right|_{\bar{\mathbf{x}}_k, \bar{\mathbf{u}}_k}
				\]
				\[
				\delta \mathbf{x}(t) = \mathbf{x}(t) - \bar{\mathbf{x}}_k, \quad
				\delta \mathbf{u}(t) = \mathbf{u}(t) - \bar{\mathbf{u}}_k
				\]
				with $k T_s \leq t < (k + 1) T_s$ for $k = k_0, \ldots, k_0 + N$
				</p>
			</div>

		</section>
		<section data-transition="fade">
			<h1 class="slide-title">LTV Model</h1>

			<div class="slide-body">

				<p>
				Then <b>discretize</b> using a forward Euler method:
				\[
				\delta \mathbf{x}_{k+1} = \mathbf{A}_{d,k} \delta \mathbf{x}_k + \mathbf{B}_{d,k} \delta
				\mathbf{u}_k
				\]
				\[
				\mathbf{A}_{d,k} = \mathbb{I} + T_s \mathbf{A}_k, \quad \mathbf{B}_{d,k} = T_s
				\mathbf{B}_k
				\]
				\[
				\delta \mathbf{x}_k = \mathbf{x}_k - \bar{\mathbf{x}}_k, \quad
				\delta \mathbf{u}_k = \mathbf{u}_k - \bar{\mathbf{u}}_k
				\]
				</p>
				<p>
				Which can eventually be rewritten as:
				\[
				\begin{aligned}
				\mathbf{x}_{k+1} &= \mathbf{A}_{d,k} \mathbf{x}_k + \mathbf{B}_{d,k} \mathbf{u}_k +
				\mathbf{d}_k\\
				\mathbf{d}_k &= \bar{\mathbf{x}}_{k+1} - \mathbf{A}_{d,k} \bar{\mathbf{x}}_k -
				\mathbf{B}_{d,k} \bar{\mathbf{u}}_k
				\end{aligned}
				\]
				</p>

			</div>

		</section>

		<!-- Slide 8: MPC Problem Formulation -------------------------------->
		<section data-transition="slide">
			<h1 class="slide-title">MPC Problem Formulation</h1>

			<div class="slide-body">

				<p>
				MPC optimization problem with horizon $N$:
				\[
				\begin{aligned}
				\min_{\mathbf{U}_{t \to t+N | t}} \quad & \mathbf{J} = \sum_{k=t}^{t+N} \left( \Delta
				\mathbf{x}_k^T \mathbf{Q} \Delta \mathbf{x}_k + \Delta \mathbf{u}_k^T \mathbf{R}
				\Delta \mathbf{u}_k \right)\\
				\text{s.t.} \quad & \mathbf{x}_{k+1 | t} = \mathbf{A}_{d,k | t} \mathbf{x}_{k |
				t} + \mathbf{B}_{d,k | t} \mathbf{u}_{k | t} + \mathbf{d}_{k | t}\\
				& \mathbf{d}_{k | t} = \bar{\mathbf{x}}_{k+1 | t} -
				\mathbf{A}_{d,k | t} \bar{\mathbf{x}}_{k | t} - \mathbf{B}_{d,k
				| t} \bar{\mathbf{u}}_{k | t}\\
				& \mathbf{x}_{k | t} \in \mathcal{X}, \quad k = t, \ldots,
				t+N\\
				& \mathbf{u}_{k | t}
				\in \mathcal{U}, \quad k = t, \ldots, t+N+1\\
				\end{aligned}
				\]
				with:
				<ul>
					<li>Difference from state reference: $\Delta
						\mathbf{x}_k = \mathbf{x}_{k | t} -
						\mathbf{x}_{\text{ref},k | t}$</li>
					<li>Difference from input reference: $\Delta \mathbf{u}_k =
						\mathbf{u}_{k | t} - \mathbf{u}_{\text{ref},k | t}$</li>
					<li>State constraints set $\mathcal{X}$</li>
					<li>Input constraints set $\mathcal{U}$</li>
					<li>Weight matrices $\mathbf{Q}$ and $\mathbf{R}$</li>
				</ul>
				</p>

			</div>

		</section>

		<!-- Slide 9: Dense & Sparse Formulations ---------------------------->

		<section data-transition="slide" data-auto-animate>
			<a id="dense-and-sparse-link"></a>
			<h1 class="slide-title">Dense & Sparse Formulations</h1>

			<div class="slide-body">

				<div class="multi-column">

					<div class="column"
						 style="width: 50%; 
								border-right: 1px solid var(--primary); 
								margin-right: 20px;
								">
						<h2 style="text-align: center;">Dense Formulation</h2>
						<p style="text-align: center;" data-id="dense-formulation">
						Introduce vectorized notation:
						\[
						\begin{aligned}
						\mathbf{X}_k &= \begin{bmatrix}
						\mathbf{x}_k^T &  \mathbf{x}_{k+1}^T & \ldots & 
						\mathbf{x}_{k+N-1}^T
						\end{bmatrix}^T\\
						\mathbf{U}_k &= \begin{bmatrix}
						\mathbf{u}_k^T &  \mathbf{u}_{k+1}^T & \ldots & 
						\mathbf{u}_{k+N-1}^T
						\end{bmatrix}^T
						\end{aligned}
						\]
						so that
						\[
						\mathbf{X}_k = \mathcal{A} \mathbf{x}_k + \mathcal{B} \mathbf{U}_k + \mathcal{D}	
						\]
						(see <a href="#appendix1">Appendix $1$</a>
						for $\mathcal{A}$,
						$\mathcal{B}$, and $\mathcal{D}$)<br>
						<br>
						Then introduce also:
						\[
						\begin{aligned}
						\mathcal{Q} &= \text{diag}(\mathbf{Q}, \ldots,
						\mathbf{Q})\\
						\mathcal{R} &= \text{diag}(\mathbf{R},
						\ldots, \mathbf{R})
						\end{aligned}
						\]
						</p>
					</div>

					<div class="column">
						<h2 style="text-align: center;">Sparse Formulation</h2>
						<p style="text-align: center;" data-id="sparse-formulation">
						Introduce vectorized notation:
						\[
						\begin{aligned}
						\delta \mathbf{X}_k &= \begin{bmatrix}
						\delta \mathbf{x}_k^T & \delta \mathbf{x}_{k+1}^T & \ldots & \delta
						\mathbf{x}_{k+N-1}^T
						\end{bmatrix}^T\\
						\delta \mathbf{U}_k &= \begin{bmatrix}
						\delta \mathbf{u}_k^T & \delta \mathbf{u}_{k+1}^T & \ldots & \delta
						\mathbf{u}_{k+N-1}^T
						\end{bmatrix}^T
						\end{aligned}
						\]
						so that
						\[
						\delta \mathbf{X}_k = \mathcal{A} \delta \mathbf{X}_k + \mathcal{B} \delta \mathbf{U}_k + \mathcal{D}	 \delta \mathbf{x}_k
						\]
						(see <a href="#appendix2">Appendix $2$</a>
						for $\mathcal{A}$, $\mathcal{B}$, and $\mathcal{D}$)<br>
						<br>
						Then introduce also:
						\[
						\begin{aligned}
						\mathcal{Q} = \text{diag}(\mathbf{Q}, \ldots,
						\mathbf{Q}), &\quad 
						\mathcal{R} = \text{diag}(\mathbf{R}, \ldots,
						\mathbf{R})\\
						\text{and} \quad \mathbf{V} &= \begin{bmatrix}
		\mathcal{Q} & \mathbf{0}\\
		\mathbf{0} & \mathcal{R}
	\end{bmatrix}
						\end{aligned}
						\]
						</p>
					</div>
				</div>
			</div>
		</section>
		<!------->
		<section data-transition="slide" data-auto-animate>
			<h1 class="slide-title">Dense & Sparse Formulations</h1>

			<div class="slide-body">

				<div class="multi-column">

					<div class="column"
						 style="width: 50%; 
								border-right: 1px solid var(--primary); 
								margin-right: 20px;
								">
						<h2 style="text-align: center;">Dense Formulation</h2>
						<p style="text-align: center;" data-id="dense-formulation">
						Rewrite cost function:
						\[
	\begin{aligned}
		\mathbf{J} &= \Delta \mathbf{X}_k^T \mathcal{Q} \Delta \mathbf{X}_k + \Delta \mathbf{U}_k^T
	\mathcal{R} \Delta \mathbf{U}_k\\
				 & = \left( \mathbf{X}_k - \mathbf{X}_{\text{ref},k} \right)^T
				 \mathcal{Q} \left( \mathbf{X}_k - \mathbf{X}_{\text{ref},k} \right) +
				 \ldots\\
				 & \quad \ldots +
				 \left( \mathbf{U}_k - \mathbf{U}_{\text{ref},k} \right)^T \mathcal{R}
				 \left( \mathbf{U}_k - \mathbf{U}_{\text{ref},k} \right)\\
				 &= \mathbf{U}_k^T \left(
						\mathcal{B}^T \mathcal{Q} \mathcal{B} + \mathcal{R}
					\right) \mathbf{U}_k + \dots\\
				& \quad\dots	+ 2 \big(
						\mathbf{x}_k^T \mathcal{A}^T \mathcal{Q} \mathcal{B} +
						\ldots\\
						& \quad \ldots
						+ \mathcal{D}^T \mathcal{Q} \mathcal{B}
						- \mathbf{X}_{\text{ref},k}^T
						\mathcal{Q} \mathcal{B} - \dots\\
					&\quad \dots	- \mathbf{U}_{\text{ref},k}^T
						\mathcal{R}
					\big) \mathbf{U}_k\\
				 &= \mathbf{U}_k^T \mathbf{H}_k \mathbf{U}_k + 2 \mathbf{f}_k^T \mathbf{U}_k
	\end{aligned}
	\]
						</p>
					</div>

					<div class="column">
						<h2 style="text-align: center;">Sparse Formulation</h2>
						<p style="text-align: center;" data-id="sparse-formulation">
						Introduce augmented vector variables:
						\[
	\mathbf{Z}_k = \begin{bmatrix}
		\mathbf{X}_k\\
		\mathbf{U}_k
	\end{bmatrix}
	\quad \text{and} \quad
	\mathbf{Z_{\text{ref},k}} = \begin{bmatrix}
		\mathbf{X}_{\text{ref},k}\\
		\mathbf{U}_{\text{ref},k}
	\end{bmatrix}
						\]
						Rewrite cost function:
						\[
	\begin{aligned}
		\mathbf{J} &= \Delta \mathbf{X}_k^T \mathcal{Q} \Delta \mathbf{X}_k + \Delta \mathbf{U}_k^T
	\mathcal{R} \Delta \mathbf{U}_k\\
				&= \Delta \mathbf{Z}_k^T \mathbf{V} \Delta \mathbf{Z}_k\\
				&= \left( \mathbf{Z}_k - \mathbf{Z}_{\text{ref},k} \right)^T \mathbf{V}
				\left( \mathbf{Z}_k - \mathbf{Z}_{\text{ref},k} \right)\\
				&= \mathbf{Z}_k^T \mathbf{V} \mathbf{Z}_k + 2 \left( -
				\mathbf{Z}_{\text{ref},k}^T \mathbf{V} \right) \mathbf{Z}_k\\
				&= \mathbf{Z}_k^T \mathbf{V}_k \mathbf{Z}_k + 2 \tilde{\mathbf{f}}_k^T \mathbf{Z}_k
	\end{aligned}
						\]
						</p>
					</div>
				</div>
			</div>
		</section>
		<!------->
		<section data-transition="slide" data-auto-animate>
			<h1 class="slide-title">Dense & Sparse Formulations</h1>

			<div class="slide-body">

				<div class="multi-column">

					<div class="column"
						 style="width: 50%; 
								border-right: 1px solid var(--primary); 
								margin-right: 20px;
								">
						<h2 style="text-align: center;">Dense Formulation</h2>
						<p style="text-align: center;" data-id="dense-formulation">
						Constraints with $\boldsymbol{\varepsilon} =
						\begin{bmatrix} +1 & -1 \end{bmatrix}^T$:
						\[
						\boldsymbol{\varepsilon} \mathbf{x}_k \leq \mathbf{f}_{\mathbf{x}} = \begin{bmatrix}
						\mathbf{x}_{\max}\\
						\mathbf{x}_{\min}
						\end{bmatrix}
						\text{ and }
						\boldsymbol{\varepsilon} \mathbf{u}_k \leq \mathbf{f}_{\mathbf{u}} = \begin{bmatrix}
						\mathbf{u}_{\max}\\
						\mathbf{u}_{\min}
						\end{bmatrix}
						\]
						Hence:
						\[
						\mathcal{E}_{\mathbf{x}} = \mathcal{E}_{\mathbf{u}} = \text{diag}(\boldsymbol{\varepsilon}), 
						\,
						\mathcal{F}_{\mathbf{x}} = \begin{bmatrix}
						\mathbf{f}_{\mathbf{x}}\\
						\vdots\\
						\mathbf{f}_{\mathbf{x}}
						\end{bmatrix},
						\,
						\mathcal{F}_{\mathbf{u}} = \begin{bmatrix}
						\mathbf{f}_{\mathbf{u}}\\
						\vdots\\
						\mathbf{f}_{\mathbf{u}}
						\end{bmatrix}
						\]
						which leads to:
						\[
						\mathcal{E} \mathbf{U}_k \leq \mathcal{F}
						\]
						\[
						\mathcal{E} = \begin{bmatrix}
						\mathcal{E}_{\mathbf{u}}\\
						\mathcal{E}_{\mathbf{x}} \mathcal{B}
						\end{bmatrix}
						\text{ and }
						\mathcal{F} = \begin{bmatrix}
						\mathcal{F}_{\mathbf{u}}\\
						\mathcal{F}_{\mathbf{x}} - \mathcal{E}_{\mathbf{x}} (\mathcal{A} \mathbf{x}_k + \mathcal{D})
						\end{bmatrix}
						\]
						</p>
					</div>

					<div class="column">
						<h2 style="text-align: center;">Sparse Formulation</h2>
						<p style="text-align: center;" data-id="sparse-formulation">
						<b>Inequality constraints</b> (same notation):
						\[
						\mathcal{E}_{\mathbf{Z}} \mathbf{Z}_k \leq \mathcal{F}_{\mathbf{Z}}
						\]
						where
						\[
						\mathcal{E}_{\mathbf{Z}} = \begin{bmatrix}
						\mathcal{E}_{\mathbf{x}} & \mathbf{0}\\
						\mathbf{0} & \mathcal{E}_{\mathbf{u}}
						\end{bmatrix}
						\quad \text{and} \quad
						\mathcal{F}_{\mathbf{Z}} = \begin{bmatrix}
						\mathcal{F}_{\mathbf{x}}\\
						\mathcal{F}_{\mathbf{u}}
						\end{bmatrix}
						\]
						<b>Equality constraints</b>:
						\[
						\begin{bmatrix}
						\mathbb{I} - \mathcal{A} & -\mathcal{B}
						\end{bmatrix}
						\delta \mathbf{Z}_k = \mathcal{D} \delta \mathbf{x}_k
						\Rightarrow
						\mathcal{E}_{\text{eq.}} \mathbf{Z}_k = \mathcal{F}_{\text{eq.}}
						\]
						where
						\[
						\begin{aligned}
						\mathcal{E}_{\text{eq.}} &= \begin{bmatrix}
						\mathbb{I} - \mathcal{A} & -\mathcal{B}
						\end{bmatrix}\\
						\mathcal{F}_{\text{eq.}} &= \mathcal{D} \delta \mathbf{x}_k + \begin{bmatrix}
						\mathbb{I} - \mathcal{A} & -\mathcal{B}
						\end{bmatrix} \bar{\mathbf{Z}}_k
						\end{aligned}
						\]
						</p>
					</div>
				</div>
			</div>
		</section>
		<!------->
		<section data-transition="slide" data-auto-animate>
			<h1 class="slide-title">Dense & Sparse Formulations</h1>

			<div class="slide-body">

				<div class="multi-column">

					<div class="column"
						 style="width: 50%; 
								border-right: 1px solid var(--primary); 
								margin-right: 20px;
								">
						<h2 style="text-align: center;">Dense Formulation</h2>
						<p style="text-align: center;
								  margin-bottom: 63px;" 
							data-id="dense-formulation">
						Final QP problem:
						\[
						\begin{aligned}
						\min_{\mathbf{U}_k} \quad & \mathbf{U}_k^T \mathbf{H}_k \mathbf{U}_k + 2 \mathbf{f}_k^T
						\mathbf{U}_k\\
						\text{s.t.} \quad & \mathcal{E} \mathbf{U}_k \leq \mathcal{F}
						\end{aligned}
						\]
						</p>
						<div class="fragment" data-fragment-index="1">
							<p>
								<ul>
									<li> QP problem</li>
									<li> decision variables: $\mathbf{U}_k$
										<b>control inputs</b></li>
									<li> <b>only inequality</b> constraints</li>
								</ul>
							</p>
						</div>
					</div>

					<div class="column">
						<h2 style="text-align: center;">Sparse Formulation</h2>
						<p style="text-align: center;"
							data-id="sparse-formulation">
						Final QP problem:
						\[
						\begin{aligned}
						\min_{\mathbf{Z}_k} \quad & \mathbf{Z}_k^T \mathbf{V} \mathbf{Z}_k + 2
						\tilde{\mathbf{f}}_k^T
						\mathbf{Z}_k\\
						\text{s.t.} \quad & \mathcal{E}_{\mathbf{Z}} \mathbf{Z}_k \leq \mathcal{F}_{\mathbf{Z}}\\
						& \mathcal{E}_{\text{eq.}} \mathbf{Z}_k = \mathcal{F}_{\text{eq.}}
						\end{aligned}
						\]
						</p>
						<div class="fragment" data-fragment-index="1">
							<p>
								<ul>
									<li> QP problem</li>
									<li> more decision variables: $\mathbf{Z}_k =
										\begin{bmatrix} \mathbf{X}_k & \mathbf{U}_k
										\end{bmatrix}^T$ </li>
									<li> <b>equality and inequality</b> constraints</li>
									<li> better for solver (sparsity)</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Slide 10: MPC Pseudocode ---------------------------------------->
		<section data-transition="slide">
			<h1 class="slide-title">MPC Algorithm Implementation</h1>

			<div class="slide-body">

				<!-- NOTE: Display notes, in reverse order of appearance -->
				<div style="position:relative; 
							padding-bottom: 20px;
							display: flex;
							justify-content: center;
				">
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="8">
						Store remaining optimization results as <b>next
							iteration nominal inputs</b>
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="7">
						Update the state vector simulating the system with the
						optimal input
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="6">
						Extract <b>optimal input</b> ($1^{\text{st}}$ input
						vector)
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="5">
						<b>Optimization phase</b>: set constraints and solve QP
						problem
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="4">
						<b>Prediction horizon loop</b>: linearize, discretize,
						build formulation matrices and fix angles
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="3">
					Set first nominal inputs from reference ($1^{\text{st}}$
					iteration)
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="2">
					Set initial conditions (<b>with</b> or <b>without</b> noise)
					</p>
					<p class="fragment fade-in-then-out"
					   style="position:absolute; text-align: center;"
					   data-fragment-index="1">
					Set horizon $N$, number of states $n$ and inputs $m$
					</p>
				</div>

					<br>

				<pre><code
				data-line-numbers="1-61|4-7|9-18|19-21|29-36|38-42|44-46|48-56|58-60"
				data-fragment-index="1">% MPC optimization function
function [x, u] = optimize(obj)

	% Define number of states, inputs and horizon
	n = obj.model.n;
	m = obj.model.m;
	N = obj.N;

	% Initialize the state and input vectors
	x = obj.x0;
	if obj.noise
		% Noise components generation for Kalman filter
		w = mvnrnd(zeros(obj.model.n, 1), obj.model.Q_tilde, obj.Nsteps);
		v = mvnrnd(zeros(obj.model.p, 1), obj.model.R_tilde, obj.Nsteps);
		x_last = obj.x0 + w(1, :)';
	else
		x_last = obj.x0;
	end
	u = [];
	obj.set_reference(1);
	u_pred = obj.U_REF;

	% Solve optimization problem at each time step
	for k = 1:obj.Nsteps

		% Set reference states and inputs with or without preview
		obj.set_reference(k);

		% Define formulation matrices
		[A, B, D] = obj.set_formulation(x_last, u_pred);

		% Fix angle representation in X_REF
		obj.X_REF = obj.model.fix_angles(obj.x_pred, obj.X_REF);

		% Set augmented reference state Z_REF
		obj.Z_REF = [obj.X_REF; obj.U_REF];

		% Set constraints matrices
		[H, f, EPS, F, EPS_eq, F_eq] = obj.set_constraints(A, B, D, x_last);

		% Solve the optimization problem and get optimal input sequence
		UMPC = obj.solve(H, f, EPS, F, EPS_eq, F_eq);

		% Extract the optimal input and update the input vector
		u_optimal = UMPC(1:m); % only pick the first inputs (of size m)
		u = [u; u_optimal];

		% Update the state vector simulating the system with the optimal input
		if obj.noise
			update_last = obj.model.simulate(x_last, u_optimal, obj.Ts) + w(k,:)';
			measured_output = obj.model.output(update_last, u_optimal) + v(k,:)';
			x_last = obj.model.EKF_estimate(x_last, u_optimal, measured_output);
		else
			x_last = obj.model.simulate(x_last, u_optimal, obj.Ts);
		end
		x = [x; x_last];

		% Update the prediction inputs with the remaining optimization results
		u_remaining = UMPC(m+1:end);
		u_pred = [u_remaining; u_remaining(end-m+1:end)]; % duplicate last inputs
	end
				</code></pre>

			</div>

		</section>
		</section>

		<!-- Slide 12: Extended Kalman Filter -------------------------------->
		<section data-name="Extended Kalman Filter">

			<section data-background-color="var(--primary)">
				<div class="section-title-container">
					<h1 style="font-size: 2em;">Extended Kalman Filter</h1>
				</div>
			</section>

			<section data-transition="slide">
				<h1 class="slide-title">Extended Kalman Filter</h1>

				<div class="slide-body">

					<p>
					Discrete-time non-linear system:
					</p>
		
					<div class="multi-column">
						<div class="column" style="width: 45%;">
							<p>
							\[
							\begin{aligned}
							\dot{\mathbf{x}}_k &= \mathbf{f}(\mathbf{x}_{k-1}, \mathbf{u}_{k-1}) + \mathbf{w}_k \\
							\mathbf{y}_k &= \mathbf{g}(\mathbf{x}_k) + \mathbf{v}_k
							\end{aligned}
							\]
							</p>
						</div>

						<div class="column" style="width: 45%;">
							<div class="cbox" style="text-align: center; padding:
										10px; font-size: 1em; margin-bottom: 10px;">
								<b>Process Noise</b>
								$\quad \mathbf{w}_k \sim \mathcal{N}(0,
								\tilde{\mathbf{Q}}_k)$
							</div>
							<div class="cbox" style="text-align: center; padding:
										10px; font-size: 1em;">
								<b>Measurement Noise</b>
								$\quad \mathbf{v}_k \sim \mathcal{N}(0,
								\tilde{\mathbf{R}}_k)$
							</div>
						</div>
					</div>

					<p>
						<b>Extended Kalman Filter (EKF)</b> steps:
					</p>
					<div class="multi-column">
						<div class="column" style="width: 10%;">
							<br>
							<h2 style="text-align: left;">1. Prediction</h2>
						</div>
						<div class="column" style="width: 90%;">
							\[
							\begin{aligned}
							\hat{\mathbf{x}}_{k | k-1} = \mathbf{f}(\hat{\mathbf{x}}_{k-1 | k-1},
							\mathbf{u}_{k-1}) \quad & \quad \text{Predicted state estimate} \\
							\mathbf{P}_{k | k-1} = \mathbf{A}_k \mathbf{P}_{k-1 | k-1} \mathbf{A}_k^T +
							\tilde{\mathbf{Q}}_{k - 1} \quad & \quad \text{Predicted covariance estimate}
							\end{aligned}
							\]
						</div>
					</div>
					<div class="multi-column">
						<div class="column" style="width: 10%;">
							<br>
							<br>
							<h2 style="text-align: left;">2. Update</h2>
						</div>
						<div class="column" style="width: 90%;">
							\[
							\begin{aligned}
							\mathbf{K}_k = \mathbf{P}_{k | k-1} \mathbf{C}_k^T \left(
							\mathbf{C}_k \mathbf{P}_{k | k-1} \mathbf{C}_k^T + \tilde{\mathbf{R}}_k
							\right)^{-1} \quad & \quad \text{Kalman gain} \\
							\hat{\mathbf{x}}_{k | k} = \hat{\mathbf{x}}_{k | k-1} + \mathbf{K}_k \left(
							\mathbf{y}_k - \mathbf{g}(\hat{\mathbf{x}}_{k | k-1})
							\right) \quad & \quad \text{Updated state estimate} \\
							\mathbf{P}_{k | k} = \left( \mathbb{I} - \mathbf{K}_k \mathbf{C}_k \right)
							\mathbf{P}_{k | k-1} \quad & \quad \text{Updated covariance
							estimate}
							\end{aligned}
							\]
						</div>
					</div>

				</div>


			</section>

		</section>

		<!-- Section: Validation and Results ---------------------------------->
		<section data-name="Validation and Results">

			<section data-background-color="var(--primary)">
				<div class="section-title-container">
					<h1 style="font-size: 2em;">Validation and Results</h1>
				</div>
			</section>

		<!-- Slide 13: Parameters & Constraints ------------------------------>
		<section data-transition="slide">
			<h1 class="slide-title">Parameters & Constraints</h1>

			<div class="slide-body">


				<div class="multi-column">

					<!-- Unicycle -->
					<div class="column" 
						 style="width: 40%; 
								border-right: 1px solid var(--primary); 
								padding-right: 10px;
								margin-right: 20px;
					">
						<h2 style="text-align: center;">Unicycle Model</h2>

						<p style="margin-bottom: 75px;">
						Model parameters:
						<br>
						\[
						\begin{aligned}
							&r = 0.03 \; \text{m}\\
							&L = 0.3 \; \text{m}\\
							&T_s = 0.1 \; \text{s}\\
							&x \in [-2, 2] \; \text{m}, \quad y \in [-2, 2] \;
							\text{m}\\ 
							&\omega_1, \; \omega_2 \in [-50, 50] \; \text{rad/s}
						\end{aligned}
						\]
						</p>


						<div class="cbox" 
							style="text-align: left;
								   padding: 10px 0px 0px 10px;
								   font-size: 1em;
								   ">
							MPC Parameters:
							\[
							\begin{aligned}
								&N = 10\\
								&\mathbf{Q} = 10^3 \cdot \mathbb{I}_{3 \times 3}\\
								&\mathbf{R} = \mathbb{I}_{2 \times 2}
							\end{aligned}
							\]
						</div>

					</div>

					<!-- Helicopter -->
					<div class="column;" style="width: 60%;">
						<h2 style="text-align: center;">Helicopter Model</h2>

						<p>
						Model parameters [<a href="#ref1">1</a>]:
						\[
						\begin{aligned}
							&b_x = 2, \quad b_y = 2, \quad b_z = 18, \quad
							b_{\psi} = 111\\
							&k_x = -0.5, \quad k_y = -0.5, \quad k_{\psi} = -5\\
							&T_s = 0.1 \; \text{s}\\
							&x_I \in [-2, 2] \; \text{m}, \quad y_I \in [-2, 2]
							\; \text{m}, \quad z_I \in [-2, 2] \; \text{m}\\
							&\ddot{x}_B \in [-3, 3] \;
							\frac{\text{m}}{\text{s}^2}, \quad \ddot{y}_B \in
							[-3, 3] \; \frac{\text{m}}{\text{s}^2}, \quad
							\ddot{z}_B \in [-2, 2] \;
							\frac{\text{m}}{\text{s}^2}\\
							&\dot{\psi} \in [-25, 25] \; \text{rad/s}, \quad
							u_i \in [-2, 2] \; \text{for } i = x, y, z, \psi
						\end{aligned}
						\]
						</p>

						<div class="cbox" 
							style="text-align: left;
								   padding: 10px 0px 0px 10px;
								   font-size: 1em;
								   ">
							MPC Parameters [<a href="#ref1">1</a>]:
							\[
							\begin{aligned}
								&N = 18\\
								&\mathbf{Q} = \text{diag}\left(50, 50, 5, 10, 3,
				3, 1, 2\right)\\
								&\mathbf{R} = 2 \cdot \mathbb{I}_{4 \times 4}
							\end{aligned}
							\]
						</div>

					</div>

				</div>
			</div>
		</section>

		<!-- Slide 14: Experimental Setup ------------------------------------>
		<section data-transition="slide">
			<h1 class="slide-title">Experimental Setup</h1>

			<div class="slide-body">

				<div class="cbox" style="font-size: 0.9em; margin-bottom: 10px;">
					<b>Experiment $1$</b>: Loop around trajectory<br>
					<ul style="padding-left: 130px;">
						<li> $N_{\text{guide}} = 100$</li>
						<li> $\mathbf{x}_0$ randomly initialized s.t. $||\mathbf{x}_0 -
							\mathbf{x}_{\text{ref}, 1}||_2 \leq 0.05$</li>
						<li> $100$ repetitions</li>
					</ul>
				</div>

				<div class="cbox" style="font-size: 0.9em; margin-bottom: 10px;">
					<b>Experiment $2$</b>: Loop around trajectory with noise<br>
					<ul style="padding-left: 130px;">
						<li> $N_{\text{guide}} = 100$</li>
						<li> $\mathbf{x}_0$ randomly initialized s.t. $||\mathbf{x}_0 -
							\mathbf{x}_{\text{ref}, 1}||_2 \leq 0.05$</li>
						<li> $20$ repetitions</li>
						<li> Process noise: $\tilde{\mathbf{Q}} = 
							0.75 \cdot 10^{-3}  \cdot
							\mathbb{I}_{n \times n}$</li>
						<li> Measurement noise: $\tilde{\mathbf{R}} = 10^{-2}
							\cdot \mathbb{I}_{m \times m}$</li>
						<li> Initial state covariance: $\mathbf{P}_0 = \mathbb{I}_{n \times n}$</li>
					</ul>
				</div>

				<div class="cbox" style="font-size: 0.9em; margin-bottom: 10px;">
					<b>Experiment $3$</b>: Increasing horizon $N$<br>
					<ul style="padding-left: 130px;">
						<li> $N = 1, 2, \ldots, 20$</li>
						<li> Same setup as Experiment $1$</li>
						<li> $10$ repetitions per $N$ value</li>
					</ul>
				</div>

			</div>
		</section>

		<!-- Slide 15: Results 1 --------------------------------------------->
		<section data-transition="slide">
			<h1 class="slide-title"> Results Experiments $1$ and $2$ </h1>

			<div class="slide-body" style="transform: translateY(-30px);">

				<p>
					Assessment metric: <b>Root Mean Squared Error (RMSE)</b>
					\[
					\text{RMSE}(\mathbf{x}) = \sqrt{\frac{1}{N_{\text{guide}}}
					\sum_{i=1}^{N_{\text{guide}}}
					|| \mathbf{x}_i - \mathbf{x}_{\text{ref}, i} ||_2^2}
					\quad \text{and} \quad
					\text{RMSE}(\mathbf{u}) = \sqrt{\frac{1}{N_{\text{guide}}}
					\sum_{i=1}^{N_{\text{guide}}}
					|| \mathbf{u}_i - \mathbf{u}_{\text{ref}, i} ||_2^2}
					\]
				</p>

				<table class="latex-table">

					<thead>
						<tr>
							<th>Model</th>
							<th>Trajectory</th>
							<th>State RMSE</th>
							<th>Input RMSE</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td rowspan="2" style="vertical-align: middle;">Unicycle</td>
							<td>Circle</td>
							<td>0.020 ± 0.007</td>
							<td>0.227 ± 0.068</td>
						</tr>
						<tr>
							<td>Lemniscate</td>
							<td>0.030 ± 0.002</td>
							<td>0.857 ± 0.023</td>
						</tr>
						<tr>
							<td rowspan="2" style="vertical-align: middle;">Helicopter</td>
							<td>Circle</td>
							<td>0.034 ± 0.013</td>
							<td>0.096 ± 0.011</td>
						</tr>
						<tr>
							<td>Lemniscate</td>
							<td>0.686 ± 0.001</td>
							<td>0.302 ± 0.007</td>
						</tr>
						<tr>
							<td rowspan="2" style="vertical-align: middle;">Unicycle<br>(with noise)</td>
							<td>Circle</td>
							<td>0.056 ± 0.015</td>
							<td>0.634 ± 0.190</td>
						</tr>
						<tr>
							<td>Lemniscate</td>
							<td>0.204 ± 0.251</td>
							<td>1.037 ± 0.106</td>
						</tr>
						<tr>
							<td rowspan="2" style="vertical-align: middle;">Helicopter<br>(with
								noise)</td>
							<td>Circle</td>
							<td>1.073 ± 0.329</td>
							<td>0.215 ± 0.025</td>
						</tr>
						<tr>
							<td>Lemniscate</td>
							<td>1.169 ± 0.207</td>
							<td>0.569 ± 0.071</td>
						</tr>
					</tbody>
				</table>

			</div>
		</section>

		<!-- Slide 17: Results No Noise Animations --------------------------->
		<section data-transition="slide">
			<h1 class="slide-title"> Results Experiments $1$ and $2$ </h1>

			<div class="slide-body">
				<p>
				Simulations without noise (<i>Unicycle</i>)
				</p>
				<div class="section-title-container" style="height: 85%;">
					<img src="./images/unicycle_MPC.gif" 
					style="height: 400px; border: 1px solid black;">
					<img src="./images/unicycle_MPC_lemniscate.gif" 
					style="height: 400px; width: 700px; border: 1px solid black;">
				</div>
			</div>
		</section>

		<!-- Slide 18: Results Noise Animations ------------------------------>
		<section data-transition="slide">
			<h1 class="slide-title"> Results Experiments $1$ and $2$ </h1>

			<div class="slide-body">
				<p>
				Simulations with noise (<i>Unicycle</i>)
				</p>
				<div class="section-title-container" style="height: 85%;">
					<img src="./images/unicycle_MPC_noise.gif"
					style="height: 400px; border: 1px solid black;">
					<img src="./images/unicycle_MPC_lemniscate_noise.gif"
					style="height: 400px; width: 700px; border: 1px solid black;">
				</div>
			</div>
		</section>

		<!-- Slide 19: Results No Noise Animations --------------------------->
		<section data-transition="slide">
			<h1 class="slide-title"> Results Experiments $1$ and $2$ </h1>

			<div class="slide-body">
				<p>
				Simulations without noise (<i>Helicopter</i>)
				</p>
				<div class="section-title-container" style="height: 85%;">
					<img src="./images/helicopter_MPC_circle_normal.gif"
					style="height: 400px; border: 1px solid black;">
					<img src="./images/helicopter_MPC_lemniscate_normal.gif" 
					style="height: 400px; width: 700px; border: 1px solid black;">
				</div>
			</div>
		</section>

		<!-- Slide 20: Results Noise Animations ------------------------------>
		<section data-transition="slide">
			<h1 class="slide-title"> Results Experiments $1$ and $2$ </h1>

			<div class="slide-body">
				<p>
				Simulations with noise (<i>Helicopter</i>)
				</p>
				<div class="section-title-container" style="height: 85%;">
					<img src="./images/helicopter_MPC_circle_noise.gif"
					style="height: 400px; border: 1px solid black;">
					<img src="./images/helicopter_MPC_lemniscate_noise2.gif"
					style="height: 400px; width: 700px; border: 1px solid black;">
				</div>
			</div>
		</section>

		<!-- Slide 19: Results 2 --------------------------------------------->
		<section data-transition="slide">
			<h1 class="slide-title">Results Experiment $3$</h1>

			<div class="section-title-container" style="height: 85%;">
				<img src="./images/unicycle-horizon.png" style="width: 50%;">
				<img src="./images/helicopter-horizon.png" style="width: 50%;">
			</div>
		</section>


		<!-- Slide 20: £D Trajectories --------------------------------------->
		<section data-transition="slide">
			<h1 class="slide-title">$3$D Trajectories with Helicopter</h1>

			<div class="slide-body">
				<div class="multi-column" style="margin-bottom: -40px;">
					<div class="column" style="width: 50%;">
						<p>
						\[
						z_I(t) = 0.05 \cdot t
						\]
						</p>
					</div>
					<div class="column" style="width: 50%;">
						<p>
						\[
						z_I(t) = 0.2 \cdot \sin(4 \cdot t)
						\]
						</p>
					</div>
				</div>
				<div class="section-title-container" style="height: 85%;
							margin-bottom: -20px;">
					<img src="./images/helicopter_MPC_3Dspiral.gif"
					style="height: 400px; width:500px; border: 1px solid black;">
					<img src="./images/helicopter_MPC_3Dsinusoid.gif"
					style="height: 400px; width: 500px; border: 1px solid black;">
				</div>
				<p>
				\[\textcolor{gray}{\bullet}: \text{Reference} \quad
				\textcolor{red}{\bullet}: \text{Target} \quad
				\textcolor{blue}{\bullet}: \text{Real Trajectory}\]
				</p>
			</div>

		</section>

		</section>

		<!-- Section: References -----------------.--------------------------->
		<section data-name="References" data-sm="false">
			<h1 class="slide-title">References</h1>

			<div class="slide-body">

				<!-- References -->
				<ol class="references">

					<a id="ref1"></a>
					<li>K. Kunz, S. M. Huck, T. H. Summers,<br>
						<i>"Fast Model Predictive Control of miniature
							helicopters"</i>,<br>
						2013 European Control Conference (ECC), 2013, Pages
						1377-1382,<br>
						<a href="https://doi.org/10.23919/ECC.2013.6669699">
							https://ieeexplore.ieee.org/document/6669699
						</a>
					</li>

					<a id="ref2"></a>
					<li>R.M. Murray,<br>
						<i>"Optimization Based Control"</i>,<br>
						California Institute of Technology, 2023, Chapter Trajectory Generation and Differential Flatness,<br>
						<a href="http://www.cds.caltech.edu/~murray/books/AM08/pdf/obc-complete_12Mar2023.pdf">
							http://www.cds.caltech.edu/~murray/books/AM08/pdf/obc-complete_12Mar2023.pdf
						</a>
					</li>

					<a id="ref3"></a>
					<li>R. E. Kalman,<br>
						<i>"A New Approach to Linear Filtering and Prediction Problems"</i>,<br>
						Journal of Basic Engineering, Volume 82, 1960, Pages 35-45,<br>
						<a href="https://doi.org/10.1115/1.3662552">
							https://asmedigitalcollection.asme.org/fluidsengineering/article-pdf/82/1/35/5518977/35_1.pdf
						</a>
					</li>

					<a id="ref4"></a>
					<li>R. E. Kalman, R. S. Bucy,<br>
						<i>"New Results in Linear Filtering and Prediction Theory"</i>,<br>
						Journal of Basic Engineering, Volume 83, 1961, Pages 95-108,<br>
						<a href="https://doi.org/10.1115/1.3658902">
							https://asmedigitalcollection.asme.org/fluidsengineering/article-pdf/83/1/95/5503549/95_1.pdf
						</a>
					</li>

					<a id="ref5"></a>
					<li>The MathWorks Inc.,<br>
						<i>"MATLAB version: 24.2.0 (R2024b)"</i>,<br>
						The MathWorks Inc., 2024,<br>
						<a href="https://www.mathworks.com">
							https://www.mathworks.com
						</a>
					</li>

				</ol>
			</div>
		</section>

		<!-- Section: Appendix -----------------.--------------------------->
		<section data-name="Appendix 1" data-sm="false">
			<a id="appendix1"></a>
			<h1 class="slide-title">Appendix $1$: Dense Formulation matrices</h1>

			<div class="slide-body">

				\[
				\begin{aligned}
				\mathcal{A} &= \begin{bmatrix}
				\mathbb{I}\\
				\mathbf{A}_{d,k}\\
				\mathbf{A}_{d,k+1} \mathbf{A}_{d,k}\\
				\vdots\\
				\mathbf{A}_{d,k+N-2} \ldots \mathbf{A}_{d,k}
				\end{bmatrix}\\ 
				\mathcal{B} &= \begin{bmatrix}
				\mathbf{0} & \mathbf{0} & \ldots & \mathbf{0} & \mathbf{0}\\
				\mathbf{B}_{d,k} & \mathbf{0} & \ldots & \mathbf{0} & \mathbf{0}\\
				\mathbf{A}_{d,k+1} \mathbf{B}_{d,k} & \mathbf{B}_{d,k+1} & \ldots & \mathbf{0} & \mathbf{0}\\
				\vdots & \vdots & \ddots & \vdots\\
				\mathbf{A}_{d,k+N-2} \ldots \mathbf{A}_{d,k} \mathbf{B}_{d,k} & \ldots & \ldots &
				\mathbf{B}_{d,k+N-2} & \mathbf{0}
				\end{bmatrix}\\
				\text{and}\quad \mathcal{D} &= \begin{bmatrix}
				\mathbf{0}\\
				\mathbf{d}_k\\
				\mathbf{A}_{d,k+1} \mathbf{d}_k + \mathbf{d}_{k+1}\\
				\mathbf{A}_{d,k+2} \mathbf{A}_{d,k+1} \mathbf{d}_k + \mathbf{A}_{d,k+2}
				\mathbf{d}_{k+1} + \mathbf{d}_{k+2}\\
				\vdots
				\end{bmatrix}
				\end{aligned}
				\]

			<div>
				<a href="#dense-and-sparse-link" class="back-button">Back to <b>Dense & Sparse
						Formulations</b></a>
			</div>

			</div>
		</section>
		<section data-name="Appendix 2" data-sm="false">
			<a id="appendix2"></a>
			<h1 class="slide-title">Appendix $2$: Sparse Formulation matrices</h1>

			<div class="slide-body">

				\[
				\begin{aligned}
				\mathcal{A} &= \begin{bmatrix}
				\mathbf{0} & \mathbf{0} & \ldots & \mathbf{0} & \mathbf{0}\\
				\mathbf{A}_{d,k} & \mathbf{0} & \ldots & \mathbf{0} & \mathbf{0}\\
				\mathbf{0} & \mathbf{A}_{d,k+1} & \ldots & \mathbf{0} & \mathbf{0}\\
				\vdots & \vdots & \ddots & \vdots\\
				\mathbf{0} & \mathbf{0} & \ldots & \mathbf{A}_{d,k+N-1} & \mathbf{0}
				\end{bmatrix}\\
				\mathcal{B} &= \begin{bmatrix}
				\mathbf{0} & \mathbf{0} & \ldots & \mathbf{0} & \mathbf{0}\\
				\mathbf{B}_{d,k} & \mathbf{0} & \ldots & \mathbf{0} & \mathbf{0}\\
				\mathbf{0} & \mathbf{B}_{d,k+1} & \ldots & \mathbf{0} & \mathbf{0}\\
				\vdots & \vdots & \ddots & \vdots\\
				\mathbf{0} & \mathbf{0} & \ldots & \mathbf{B}_{d,k+N-1} & \mathbf{0}
				\end{bmatrix}\\
				\mathcal{D} &= \begin{bmatrix}
				\mathbb{I}\\
				\mathbf{0}\\
				\vdots\\
				\mathbf{0}\\
				\end{bmatrix}
				\end{aligned}
				\]

				<div>
					<a href="#dense-and-sparse-link" class="back-button">Back to <b>Dense & Sparse
							Formulations</b></a>
				</div>

			</div>
		</section>


		<!-- End of slides -->
		</div>
		</div>


		<!-- Plugins and more ------------------------------------------------>
		<script src="dist/reveal.js"></script>
		<script src="plugin/simplemenu/simplemenu.js"></script>
		<script src="plugin/zoom/zoom.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/math/math.js"></script>
		<script>
			// INFO: More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				
				// General configuration settings
				transition: 'fade',
				backgroundTransition: 'fade',
				hideInactiveCursor: true,
				hideCursorTime: 900,

				// INFO: Simplemenu Top Bar
				// https://github.com/Martinomagnifico/reveal.js-simplemenu
				simplemenu: {
					inherit: "previous",
					barhtml: {
						header: "<div class='menubar' style='background-color: var(--primary); color: white;'><ul class='menu'></ul></div>"
					}
				},

				// INFO: Learn about plugins: https://revealjs.com/plugins/
				plugins: [
					Simplemenu,
					RevealMath.KaTeX,
					RevealHighlight,
					RevealNotes,
					RevealZoom,
				]
			});
		</script>


	</body>
</html>
